<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body>
  <script>
    const body = document.querySelector('body');
    const section = document.createElement('section');
    body.prepend(section)

    const userTitle = document.createElement('h1');
    const postsTitle = document.createElement('h1');
    userTitle.textContent = 'LIST OF USERS'
    postsTitle.textContent = 'POSTS OF USER #1'

    section.append(userTitle);
    section.append(postsTitle);

    const userContainer = document.createElement('div');
    userContainer.classList.add('users-container')
    userContainer.setAttribute("style", "display:flex; flex-wrap: wrap;");
    const postContainer = document.createElement('div');
    postContainer.classList.add('posts-container')

    userTitle.after(userContainer);
    postsTitle.after(postContainer);


    const fetchUserInfo = (url) => {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.onload = () => {
          if (xhr.status === 200) {
            resolve(JSON.parse(xhr.response))
          }
          else {
            reject(new Error('Rejected'));
          }
        }
        xhr.send()
      })
    }


    const makeSerialRequest = (urls) => {
      urls.reduce((acc, url) => {
        return acc.then(() => fetchUserInfo(url)
          .then(comments => {
            const commentsDiv = document.querySelector(`.comments${comments[0].postId}`);
            const html = [];

            comments.forEach(el => html.push(`<li style="font-style: italic;"> ${el.body}</li>`))

            const commentToDisplay = html.join('');
            commentsDiv.innerHTML += commentToDisplay;
          })
        );
      }, Promise.resolve());
    };


    fetchUserInfo('https://jsonplaceholder.typicode.com/users')
      .then(users => {
        users.forEach(user => {
          const usersToDisplay = `
            <div style="border:1px solid black; margin: 5px; padding:5px; width:300px;">
              <p><b>ID</b>: ${user.id}</p>
              <div><b>NAME</b>: ${user.name} ${user.username}</div>
            </div>`

          userContainer.innerHTML += usersToDisplay;
        })

        const userPostsUrls = [];
        
        for (i = 0; i < 10; i++) {
          userPostsUrls.push(`https://jsonplaceholder.typicode.com/posts/${i + 1}`)
        }

        return userPostsUrls;
      })
      .then(userPostsUrls => {
        return Promise.all(userPostsUrls.map(fetchUserInfo)).then(posts => {
          const postsContainer = document.querySelector('.posts-container');

          posts.forEach(post => {
            const postToDisplay = `
            <div style = "border:1px solid black; margin: 5px; padding:5px;"> 
              <p><b>POST ID</b>: ${post.id}</p>
              <p><b>TITLE</b>: ${post.title}</p>
              <p><b>CONTENT</b>: ${post.body}</p>
              <h2>Comments</h2>
              <ul class="comments${post.id}"></ul>
            </div>`;

            postsContainer.innerHTML += postToDisplay
          })

          const postsQuantity = posts.length;
          const commentsUrls = [];

          for (i = 0; i < postsQuantity; i++) {
            commentsUrls.push(`https://jsonplaceholder.typicode.com/comments?postId=${i + 1}`)
          }
          return commentsUrls;
        })
      })
      .then(commentsUrls => {
        makeSerialRequest(commentsUrls);
      })

  </script>
</body>
</html>